pipeline {
    agent any

    tools {
        jdk 'java25'
    }

    environment {
        GITHUB_OWNER = '251027-Java'
        GITHUB_REPO = 'P2-feedback.fm-deployed'
        GITHUB_DEFAULT_BRANCH = 'main'
    }

    stages {
        stage('Check run requirements') {
            steps {
                script {
                    if (GIT_BRANCH == 'origin/' + GITHUB_DEFAULT_BRANCH) {
                        echo 'This is the default branch and will run'
                        return
                    }

                    echo 'Checking if this has an open PR that is targetting the default branch'

                    // https://www.jenkins.io/blog/2020/04/16/github-app-authentication/#how-do-i-get-an-api-token-in-my-pipeline
                    withCredentials([usernamePassword(credentialsId: 'github-app-team', usernameVariable: 'GITHUB_APP', passwordVariable: 'GITHUB_ACCESS_TOKEN')]) {
                        env.TEMP_VAR = "$GITHUB_ACCESS_TOKEN"

                        def response = httpRequest url: "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/commits/${GIT_COMMIT}/pulls",
                            customHeaders: [
                                [name: 'X-GitHub-Api-Version', value: '2022-11-28'],
                                [name: 'Accept', value: 'application/vnd.github+json'],
                                [name: 'Authorization', value: 'Bearer ${GITHUB_ACCESS_TOKEN}']
                            ]

                        if (response.status != 200) {
                            error "Unsuccess API call for PRs: Code ${response.status}"
                        }

                        def prList = readJSON text: response.content
                        def validOpen = prList.any { it.state == 'open' && it.base.ref == GITHUB_DEFAULT_BRANCH }

                        if (validOpen) {
                            echo "Commit has an open PR to ${GITHUB_DEFAULT_BRANCH}"
                            return
                        }

                        currentBuild.result = 'ABORTED'
                        error "Does not meet the requirements to run: ${GIT_COMMIT}"
                    }
                }
            }
        }

        stage('Info') {
            steps {
                // publishChecks(name: 'Build Info', status: 'IN_PROGRESS', summary: 'running', title: 'A title')
                echo "Build tag: ${env.BUILD_TAG}"
                echo "Branch: ${GIT_BRANCH}"
                echo "Commit: ${GIT_COMMIT}"

                // for debugging. remove this later
                sh 'printenv | sort'
            }
            post {
                success {
                    echo "success"
                    // httpRequest authentication: 'main-github-pat',
                    //     url: "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/statuses/${GIT_COMMIT}",
                    //     customHeaders: [
                    //         [name: 'X-GitHub-Api-Version', value: '2022-11-28'],
                    //         [name: 'Accept', value: 'application/vnd.github+json']
                    //     ],
                    //     requestBody: '''
                    //     {
                    //         "state": "success",
                    //         "description": "something succeeded",
                    //         "context": "jenkins-random-check"
                    //     }
                    //     '''
                    // publishChecks name: 'example', title: 'Pipeline Check', summary: 'check through pipeline',
                    //     text: 'you can publish checks in pipeline script',
                    //     detailsURL: 'https://github.com/jenkinsci/checks-api-plugin#pipeline-usage',
                    //     status: 'COMPLETED',
                    //     conclusion: 'SUCCESS'
                }
                // failure {
                //     publishChecks(name: 'Build Info', status: 'COMPLETED', summary: 'Failed', conclusion: 'FAILURE', title: 'A title')
                // }
            }
        }
    }
}
