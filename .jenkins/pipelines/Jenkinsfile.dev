pipeline {
    agent any

    tools {
        jdk 'java25'
    }

    environment {
        GITHUB_OWNER = '251027-Java'
        GITHUB_REPO = 'P2-feedback.fm-deployed'
        GITHUB_PAT = credentials('main-github-pat')
    }

    stages {
        stage('Check if should run') {
            steps {
                script {
                    def apiUrl = "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/commits/${GIT_COMMIT}/pulls"

                    def response = httpRequest url: apiUrl,
                                    customHeaders: [[name: 'X-GitHub-Api-Version', value: '2022-11-28']],
                                    authorization: 'Bearer ${GITHUB_PAT}',
                                    acceptType: 'application/vnd.github+json'
                    
                    def prs = readJSON text: response.content
                    def openPrs = prs.findAll { it.state == 'open' }

                    if (openPrs.size() == 0) {
                        error "❌ Commit ${COMMIT_SHA} is not part of any open PR!"
                    } else {
                        echo "✅ Commit is part of open PR(s): ${openPrs*.number}"
                    }
                }
            }
        }

        stage('Info') {
            steps {
                publishChecks(name: 'Build Info', status: 'IN_PROGRESS', summary: 'running', title: 'A title')
                echo "Build tag: ${env.BUILD_TAG}"
                echo "Branch: ${GIT_BRANCH}"
                echo "Commit: ${GIT_COMMIT}"

                // for debugging. remove this later
                sh 'printenv | sort'
            }
            post {
                success {
                    // githubNotify(context: 'Build Info', description: 'Success', status: 'SUCCESS')
                    publishChecks(name: 'Build Info', status: 'COMPLETED', summary: 'Success', conclusion: 'SUCCESS', title: 'A title')
                }
                failure {
                    // githubNotify(context: 'Build Info', description: 'Failed', status: 'FAILURE', title: 'A title')
                    publishChecks(name: 'Build Info', status: 'COMPLETED', summary: 'Failed', conclusion: 'FAILURE', title: 'A title')
                }
            }
        }
    }
}
