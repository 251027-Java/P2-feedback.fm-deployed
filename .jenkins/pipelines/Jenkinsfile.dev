pipeline {
    agent any

    tools {
        jdk 'java25'
    }

    environment {
        GITHUB_OWNER = '251027-Java'
        GITHUB_REPO = 'P2-feedback.fm-deployed'
        GITHUB_DEFAULT_BRANCH = 'main'
    }

    stages {
        stage('Check if should run') {
            steps {
                script {
                    def apiUrl = "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/commits/${GIT_COMMIT}/pulls"

                    def response = httpRequest url: apiUrl,
                                    customHeaders: [
                                        [name: 'X-GitHub-Api-Version', value: '2022-11-28'],
                                        [name: 'Accept', value: 'application/vnd.github+json']
                                    ],
                                    authentication: 'main-github-pat'
                    
                    if (response.status != 200) {
                        error "Unsuccess API call for PRs: Code ${response.status}"
                    }
                    
                    def prs = readJSON text: response.content
                    def validOpen = prs.any { it.state == 'open' && it.base.ref == GITHUB_DEFAULT_BRANCH }

                    if (!validOpen) {
                        currentBuild.result = 'ABORTED'
                        error "Does not meet the requirements to run: ${GIT_COMMIT}"
                    }

                    echo "Commit has an open PR to ${GITHUB_DEFAULT_BRANCH}"
                }
            }
        }

        stage('Info') {
            steps {
                publishChecks(name: 'Build Info', status: 'IN_PROGRESS', summary: 'running', title: 'A title')
                echo "Build tag: ${env.BUILD_TAG}"
                echo "Branch: ${GIT_BRANCH}"
                echo "Commit: ${GIT_COMMIT}"

                // for debugging. remove this later
                sh 'printenv | sort'
            }
            post {
                success {
                    // githubNotify(context: 'Build Info', description: 'Success', status: 'SUCCESS')
                    publishChecks(name: 'Build Info', status: 'COMPLETED', summary: 'Success', conclusion: 'SUCCESS', title: 'A title')
                }
                failure {
                    // githubNotify(context: 'Build Info', description: 'Failed', status: 'FAILURE', title: 'A title')
                    publishChecks(name: 'Build Info', status: 'COMPLETED', summary: 'Failed', conclusion: 'FAILURE', title: 'A title')
                }
            }
        }
    }
}
